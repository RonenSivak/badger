---
description: Force MCP-S tools for Grafana, DevEx, Jira, Slack during /troubleshoot
globs: ".cursor/commands/troubleshoot/**,.cursor/troubleshoot/**"
alwaysApply: false
---

# MCP-S Mandate (Non-Negotiable)

## Purpose

MCP-S (`user-MCP-S` server) provides access to internal knowledge sources:
- **Grafana** — Logs, metrics, alerts, incidents, on-call
- **DevEx** — Code ownership, builds, commits, releases
- **Jira** — Bug reports, requirements, related tickets
- **Slack** — Team discussions, decisions, context

---

## Root Cause Analysis Tools (PRIMARY for Request ID Tracing)

### 1) Start Root Cause Analysis (MANDATORY for request IDs)

```
server: user-MCP-S-root-cause
toolName: start_root_cause_analysis
arguments:
  requestId: "<x-wix-request-id>"           # REQUIRED: from network response headers
  artifactIds: ["<service-name>"]           # OPTIONAL: filter to specific services
  hint: "<context about the issue>"         # OPTIONAL: guide the analysis
  fromDate: "<ISO8601>"                     # OPTIONAL: defaults to 2 min before request
  toDate: "<ISO8601>"                       # OPTIONAL: defaults to 11 min after request
```

**Use when:** ALWAYS when you have an `x-wix-request-id` from a failed/suspicious network request.

**Returns:** `analysisId` and `pollingUrl` — analysis runs async (4-5 minutes typical).

### 2) Await Root Cause Analysis

```
server: user-MCP-S-root-cause
toolName: await_root_cause_analysis
arguments:
  analysisId: "<from start response>"       # REQUIRED
  timeoutSeconds: 25                        # OPTIONAL: defaults to 25s, max 600s
```

**Use when:** After `start_root_cause_analysis` to poll for results.

**Returns:**
- `RUNNING`: Analysis in progress — call again with same `analysisId`
- `COMPLETED`: Markdown report with root cause findings + `analysisUrl`
- `FAILED`: Reason for failure — proceed to Grafana fallback

**Polling pattern:**
```
start_root_cause_analysis → get analysisId
  ↓
await_root_cause_analysis(analysisId)
  ↓
RUNNING? → wait, call again
COMPLETED? → use findings
FAILED? → fallback to Grafana logs
```

---

## Grafana Tools (Backend Debugging / FALLBACK for Request ID)

### 1) Find Error Patterns (START HERE for backend bugs)

```
server: user-MCP-S
toolName: grafana-mcp__find_error_pattern_logs
arguments:
  name: "<investigation-name>"
  labels: { "app": "<service-name>" }
  start: "<ISO8601 datetime>"  # optional, defaults to 30m ago
  end: "<ISO8601 datetime>"    # optional, defaults to now
```

**Use when:** First tool for backend errors — finds elevated patterns compared to baseline.

### 2) Query Loki Logs

```
server: user-MCP-S
toolName: grafana-mcp__query_loki_logs
arguments:
  datasourceUid: "<loki-uid>"
  logql: '{app="<service>"} |= "<error text or request ID>"'
  limit: 100
  direction: "backward"  # newest first
```

**Use when:** Searching logs by service, trace ID, error message.

**Note:** Use `grafana-mcp__list_datasources` with `type: "loki"` to find the UID first.

### 3) List Datasources

```
server: user-MCP-S
toolName: grafana-mcp__list_datasources
arguments:
  type: "loki"  # or "prometheus"
```

**Use when:** Finding datasource UIDs for log/metric queries.

### 4) Get SIFT Analysis (AI-powered RCA)

```
server: user-MCP-S
toolName: grafana-mcp__get_sift_analysis
arguments:
  investigationId: "<uuid>"
  analysisId: "<uuid>"
```

**Use when:** Getting automated root cause analysis from Grafana.

### 5) List Incidents

```
server: user-MCP-S
toolName: grafana-mcp__list_incidents
arguments: {}
```

**Use when:** Checking for active/recent incidents.

### 6) Find Slow Requests

```
server: user-MCP-S
toolName: grafana-mcp__find_slow_requests
arguments:
  name: "<investigation-name>"
  labels: { "app": "<service>" }
```

**Use when:** Diagnosing performance issues.

### 7) Query Prometheus Metrics

```
server: user-MCP-S
toolName: grafana-mcp__query_prometheus
arguments:
  datasourceUid: "<prometheus-uid>"
  promql: 'histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{app="<service>"}[5m]))'
```

**Use when:** Querying latency, throughput, error rate metrics.

### 8) Get Current On-Call

```
server: user-MCP-S
toolName: grafana-mcp__get_current_oncall_users
arguments: {}
```

**Use when:** Finding who to escalate to.

---

## DevEx Tools (Ownership & CI/CD)

### 1) Code Owners (MANDATORY for affected code)

```
server: user-MCP-S
toolName: devex__code_owners_for_path
arguments:
  repositoryUrl: "git@github.com:wix-private/<repo>.git"
  path: "<file or directory path>/"
```

**Use when:** Finding who owns the buggy code.

### 2) Where Is My Commit

```
server: user-MCP-S
toolName: devex__where_is_my_commit
arguments:
  commitSha: "<sha>"
```

**Use when:** Tracking if a fix is deployed.

### 3) Get Build Status

```
server: user-MCP-S
toolName: devex__get_build
arguments:
  buildId: "<build-id>"
```

**Use when:** Checking build status after a fix.

### 4) Get Rollout History

```
server: user-MCP-S
toolName: devex__get_rollout_history
arguments:
  projectName: "<project>"
```

**Use when:** Checking deployment timeline.

---

## Context Tools (Jira/Slack)

### 1) Get Jira Issues

```
server: user-MCP-S
toolName: jira__get-issues
arguments:
  projectKey: "PROJECT"
  jql: "text ~ '<error message>'"
  maxResults: 10
```

**Use when:** Finding related bug reports, requirements.

### 2) Search Slack Messages

```
server: user-MCP-S
toolName: slack__search-messages
arguments:
  searchText: "<keywords>"
  in: "#channel-name"  # optional
```

**Use when:** Finding team discussions about the bug.

---

## Tool Selection by Bug Type

| Bug Type | Required Tools |
|----------|----------------|
| **Request ID Tracing** | `start_root_cause_analysis` → `await_root_cause_analysis` (PRIMARY) |
| Request ID Fallback | `query_loki_logs` (ONLY if RCA non-informative) |
| Backend Error | `find_error_pattern_logs` → `query_loki_logs` → `get_sift_analysis` |
| Performance | `find_slow_requests` → `query_prometheus` |
| Deployment | `where_is_my_commit` → `get_build` → `get_rollout_history` |
| Ownership | `code_owners_for_path` (ALWAYS required) |
| Context | `jira__get-issues` + `slack__search-messages` |

---

## Mandatory Tool Usage

### All Bugs — MUST use:
- [ ] `code_owners_for_path` — who owns affected code
- [ ] `jira__get-issues` — related tickets

### Request ID Found — MUST use:
- [ ] `start_root_cause_analysis` — AI-powered RCA (PRIMARY, MANDATORY)
- [ ] `await_root_cause_analysis` — poll until complete
- [ ] `query_loki_logs` — ONLY as fallback if RCA non-informative

### Backend Bugs — MUST use:
- [ ] `find_error_pattern_logs` — error patterns
- [ ] `query_loki_logs` — detailed logs
- [ ] `list_incidents` — check incidents

### Performance Issues — MUST use:
- [ ] `find_slow_requests` (backend) OR Chrome DevTools perf (frontend)
- [ ] `query_prometheus` — metrics

---

## Logging Requirement

All MCP-S queries and findings must be appended to:
`.cursor/troubleshoot/<topic>/mcp-s-notes.md`

Format:
```markdown
## [Evidence/Topic]
- **Tool**: <tool name>
- **Phase**: Evidence | Profiling | Escalation | Discovery
- **Arguments**: <exact args>
- **Findings**: <key insights>
- **Links/IDs**: <trace IDs, dashboard URLs, incident IDs>
- **Follow-up**: <next tool or code to investigate>
```

---

## NOT FOUND Rule

If MCP-S search yields no results:
- Mark as "MCP-S: NOT FOUND"
- List exact queries attempted (tool + arguments)
- Note which sources were searched
